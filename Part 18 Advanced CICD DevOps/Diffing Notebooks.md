# Diffing Notebooks

Canonical documentation for Diffing Notebooks. This document defines concepts, terminology, and standard usage.

## Purpose
Diffing Notebooks addresses the challenge of identifying, visualizing, and reconciling differences between versions of computational notebooks (e.g., `.ipynb` files). Unlike standard source code files, notebooks are structured documents—typically stored as JSON—that encapsulate code, rich text (Markdown), execution metadata, and multimedia outputs. 

Standard line-based diffing tools often fail to provide meaningful insights for notebooks because minor changes in the document structure or non-essential metadata (such as execution counts or timing data) generate significant "noise." This topic exists to define the methodologies for isolating semantic changes in logic from incidental changes in document state.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative.

## Scope
Clarify what is in scope and out of scope for this topic.

**In scope:**
* Structural comparison of JSON-based computational documents.
* Categorization of notebook components (Source, Metadata, Outputs).
* Logic for filtering and ignoring non-semantic changes.
* Conflict resolution strategies in a notebook context.

**Out of scope:**
* Specific vendor implementations or software (e.g., nbdime, ReviewNB, GitHub's native renderer).
* Comparison of non-computational documents (e.g., standard PDFs or Word docs).
* Real-time collaborative editing protocols (e.g., CRDTs), except where they relate to version comparison.

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| **Cell** | The fundamental unit of a notebook, containing either source code, markdown text, or raw data. |
| **Source** | The user-authored content within a cell (code or text). |
| **Output** | The result generated by executing a code cell, which may include text, HTML, images, or specialized widgets. |
| **Metadata** | Non-executable data attached to the notebook or individual cells (e.g., kernel information, cell tags, execution timestamps). |
| **Execution Count** | An integer indicating the sequence in which a cell was run during a session. |
| **Semantic Diff** | A comparison that focuses on changes to logic or narrative, ignoring incidental changes like execution counts or minor metadata updates. |
| **Structural Diff** | A comparison that respects the JSON hierarchy of the notebook file rather than treating it as a flat text file. |

## Core Concepts

### The Noise-to-Signal Problem
Notebook files are highly volatile. A single execution of a notebook can change execution counts, timestamps, and binary output strings (like base64 encoded images) without any change to the underlying code. A standard diff treats these as "changes," obscuring the actual modifications made by the author.

### Component-Level Granularity
Effective diffing requires decomposing the notebook into three distinct streams:
1.  **Source Stream:** The actual logic or prose.
2.  **Output Stream:** The results of the logic.
3.  **Metadata Stream:** The configuration and state.

### JSON-Awareness
Because most notebooks are serialized as JSON, diffing must be "structure-aware." A line-based diff might report a conflict if a comma is added to a list, whereas a structural diff understands the change within the context of the JSON object model.

## Standard Model

The standard model for notebook diffing follows a hierarchical comparison process:

1.  **Normalization:** Before comparison, non-semantic fields (like execution counts or specific volatile metadata) are optionally stripped or ignored.
2.  **Cell Alignment:** The algorithm identifies which cells in Version A correspond to cells in Version B. This is typically done using unique cell IDs or by calculating the similarity of cell content.
3.  **Per-Cell Comparison:**
    *   **Type Check:** Determining if a cell changed from Code to Markdown.
    *   **Source Diff:** Performing a standard text diff on the code or markdown content.
    *   **Output Diff:** Comparing the mime-type bundles of the outputs.
4.  **Presentation:** The differences are rendered in a way that mirrors the notebook's visual structure, rather than showing raw JSON syntax.

## Common Patterns

### Output Scrubbing
The practice of clearing all outputs before committing a notebook to version control. This ensures that the diff only contains changes to the source code, effectively reducing the file to its "source" state.

### Metadata Filtering
Configuring the diff engine to ignore specific keys in the JSON structure (e.g., `metadata.execution` or `metadata.widgets`) to prevent "dirty" diffs caused by environment-specific settings.

### Visual Diffing
Presenting the diff in a side-by-side graphical interface that renders Markdown and plots, allowing the reviewer to see the impact of code changes on the resulting visualizations.

## Anti-Patterns

### Line-Based Text Diffing
Treating a `.ipynb` file as a standard text file in a version control system. This leads to unreadable diffs and high risk of merge conflicts that break the JSON structure, rendering the notebook unopenable.

### Committing Large Binary Outputs
Including high-resolution images, videos, or large data tables in the notebook outputs committed to a repository. This bloats the version history and makes diffing significantly slower and less meaningful.

### Manual JSON Editing
Attempting to resolve merge conflicts by manually editing the JSON strings. This is error-prone and frequently leads to syntax errors that invalidate the notebook file.

## Edge Cases

*   **Cell Reordering:** If a user moves a cell from the top of the notebook to the bottom without changing its content, a basic diff may show a "deletion" and an "insertion." A sophisticated diffing tool should identify this as a "move" operation.
*   **Non-Deterministic Outputs:** Cells that produce different outputs on every run (e.g., a cell printing the current timestamp or a random number). These create "false positive" diffs.
*   **Widget State:** Interactive widgets often store their state in the notebook metadata. Diffing these requires specialized logic to determine if the state change is meaningful.
*   **Mime-type Mismatches:** A cell might produce multiple output formats (e.g., Plain Text and HTML). A diff must decide how to prioritize these formats when comparing versions.

## Related Topics
*   **Version Control Systems (VCS):** The underlying infrastructure for storing notebook history.
*   **JSON Schema:** The formal definition of the notebook file structure.
*   **Literate Programming:** The philosophical basis for combining code and narrative.
*   **Kernel State:** The ephemeral execution environment that generates notebook outputs.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-01-15 | Initial AI-generated canonical documentation |